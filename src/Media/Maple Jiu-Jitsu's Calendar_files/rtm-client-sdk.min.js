"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},EventEmitter=function(){this.events={}},self=this;EventEmitter.prototype.addEventListener=EventEmitter.prototype.on=function(e,t){"object"!==_typeof(this.events[e])&&(this.events[e]=[]),this.events[e].push(t)},EventEmitter.prototype.off=EventEmitter.prototype.removeListener=function(e,t){var n;"object"===_typeof(this.events[e])&&(n=this.events[e].indexOf(t))>-1&&this.events[e].splice(n,1)},EventEmitter.prototype.emit=function(e){var t,n,o,i=[].slice.call(arguments,1);if("object"===_typeof(this.events[e]))for(o=(n=this.events[e].slice()).length,t=0;t<o;t++)n[t].apply(this,i)},EventEmitter.prototype.once=function(e,t){this.on(e,(function n(){this.removeListener(e,n),t.apply(this,arguments)}))};_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var Utils={inherits:function(e,t){e.prototype=Object.create(t.prototype)},checkApiKey:function(e){if("string"!=typeof e||!e.length)throw new RTMServerException("Invalid ApiKey");return e},parseOptions:function(e,t){var n={};for(var o in e=e||{},t)t.hasOwnProperty(o)&&(e.hasOwnProperty(o)?n[o]=e[o]:n[o]=t[o]);return n},getWebsocketUrl:function(e,t,n){return"live"===t?"wss://rtmserver.anywhereworks.com/connection?apiKey="+e+"&socketId="+n:"staging"===t?"wss://stagingrtm.anywhereworks.com/connection?apiKey="+e+"&socketId="+n:"ws://localhost:4080/connection?apiKey="+e+"&socketId="+n},getRTMUrl:function(e){return"live"===e?"https://rtmserver.anywhereworks.com":"staging"===e?"https://stagingrtm.anywhereworks.com":"http://localhost:4080"},parseJson:function(e){try{return JSON.parse(e)}catch(e){return console.error("Error occurred while parsing JSON : ",e),""}},stringify:function(e){try{if(e&&"object"===(void 0===e?"undefined":_typeof(e)))return JSON.stringify(e)}catch(e){return logger.error("Error occurred while stringifing obj : ",e),""}},createUUId:function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-yyyy-yxxx-xxxxxxxxxxxx".replace(/[x4y]/g,(function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)}))},getSocketMessage:function(e,t,n,o){return{channel:e,type:t,data:n,meta:o}},isConnectedToNetwork:function(){return navigator.onLine},isConnectedToInternet:function(e,t){var n=new(window.ActiveXObject||XMLHttpRequest)("Microsoft.XMLHTTP");n.open("HEAD",Utils.getRTMUrl(e)+"/?rand="+Math.floor(65536*(1+Math.random())),!0);try{n.send(),n.addEventListener("readystatechange",(function(){4==n.readyState&&(n.status>=200&&n.status<=304?t(!0):t(!1))}),!1)}catch(e){t(!1)}},isValidArray:function(e){return!!(e&&e.constructor===Array&&e.length>0)},save:function(e,t,n){var o=60*n*1e3,i={value:JSON.stringify(t),timestamp:Date.now()+o};return localStorage.setItem(e,JSON.stringify(i)),t},load:function(e){var t,n=localStorage.getItem(e);return n&&(t=JSON.parse(n)),!(!t||!t.value)&&(Date.now()<t.timestamp&&JSON.parse(t.value))},isValidString:function(e){return"string"==typeof e&&""!=e&&"undefined"!=e&&"null"!=e},isValidSocketId:function(e){return this.isValidString(e)&&45===e.length},factory:function(){var e=0;return{getCount:function(){return e},incrementCount:function(){e+=1}}}(),createLogger:function(e,t){const n=`RTM[${e.split("-")[0]}]`;return{log(...e){console.log(n,...e)},debug(...e){console.debug(n,...e)},error(...e){console.error(n,...e)}}}},ConnectionFactory=function(e){var t,n,o,i,r,c,s,a=0,l=0,u=[],d="rtm-socketid",f=0,y="online";function p(){let t;return p.counter||(p.counter=0),p.counter++,t=p.counter<=3?[5,10,20][p.counter-1]:4===p.counter?Math.floor(61*Math.random())+60:Math.floor(61*Math.random())+120,e.log(`Retry counter ${p.counter} , Retry Interval:`,t),1e3*t}function g(i,r,l){let y=this;clearTimeout(s),n&&n.close&&(n.close(),n=null),n=new WebSocket(Utils.getWebsocketUrl(i,r,l)),e.log(`Socket Readystate: ${n.readyState} at : ${Date.now()}`),n.onopen=function(t){clearTimeout(s),e.log(`Socket connected at : ${Date.now()} , readyState ${n.readyState}`),a=0,p.counter=0,clearTimeout(c),S.call(y),w.call(y)},n.onclose=function(n){Utils.save(d,o,1),t="disconnected",y.emit(t),e.log(`Socket closed at : ${Date.now()} , close code ${n.code} & reason: ${n.reason}`),b.call(y),1e3!==n.code&&(e.log(`Attempting to reconnect at : ${Date.now()} , close code ${n.code}`),v.call(y))},n.onerror=function(t){e.debug("Connection to server errored : ",t.data)},n.onmessage=function(i){f=Date.now();var r=Utils.parseJson(i.data);"server-connect"===r.type?(o=r.data.socketId,e.log("New socket created:",o,"at",Date.now()),t="connected",n.socketId=o,y.emit(t,o)):"server-pingpong"===r.type?u.push(r.data.id):"server-subscriptionresponse"===r.type?y.emit("server-subscriptionresponse",r):y.emit("message",r)},s=setTimeout((()=>{g.call(this,i,r,l)}),p())}function h(n,i){var r=this;I.call(r),t="connecting",r.emit(t);var c=o||r.options.oldSocketId;c=!!Utils.isValidSocketId(c)&&c,e.log("Triggering connection at :",Date.now()),g.call(r,n,i,c)}function v(){var n=this;if(a>=n.maxReconnects)return a=0,t="failed",void n.emit("failed");var o=1e3*m.call(n);e.debug("Next Attempt in "+o+" milliseconds"),n.emit("reconnect",o),setTimeout((function(){n.reconnect()}),o),a++}function m(){var t=this.reconnectInterval*Math.pow(this.reconnectFactor,a);return t=t>this.maxReconnectInterval?this.maxReconnectInterval:t,e.debug("Reconnect Interval : "+t),t}function w(){var t=this,o=(new Date).getTime();clearInterval(r),r=setInterval((function(){var i=(new Date).getTime();i>o+1e4&&(e.log("System came back from sleep!","Socket ReadyState:",n&&n.readyState,Date.now()),n&&1===n.readyState&&(e.log("System came back from sleep and websocket says connected!"),t.sendMessage(Utils.stringify(x(++l))),k.call(t,l))),o=i}),5e3),e.log("Sleep Detection Timer Activated at : ",Date.now())}function S(){var t=this;clearInterval(i),i=setInterval((function(){var n=Date.now();n>=f+43e3?(t.sendMessage(Utils.stringify(x(++l))),k.call(t,l),e.debug("Received No Message In Last 45 Seconds. Sending Ping : "+l)):e.debug("Received Message In Last 45 Seconds"),f=n}),45e3),e.log("PingPong Activated at : "+Date.now())}function b(){clearInterval(i),clearTimeout(c),clearInterval(r),e.log("Timeouts Cleared at : "+Date.now()),u=[]}function k(t){c=setTimeout((function(t,n){-1===u.indexOf(t)?(e.log(`Pong Not Received for id ${t} at ${Date.now()}`),h.call(n,n.apiKey,n.mode)):e.debug("Pong Received : "+t)}),3e3,t,this)}function x(e){return{channel:"server/pingpong",type:"server-pingpong",meta:{id:e}}}function I(){!n||1!==n.readyState&&0!==n.readyState||(e.debug("Closing connection socketId : ",o),n.onclose=function(t){e.debug("Disabled onClose as its delebrate-destroy : "+t.code+" reason : "+t.reason+" socketId : "+this.socketId)},n.close(1e3,"delebrate-destroy"),t="disconnected",this.emit(t),e.log(`DestroyConnection method called at ${Date.now()}`),b.call(this))}function E(){this.options.customNetworkCheck&&(D.prototype.triggerNetworkConnection=function(){"offline"===y&&(y="online",R.call(this))},D.prototype.triggerNetworkDisconnection=function(){"online"===y&&(y="offline",U.call(this))})}function M(){e.log("Options :",JSON.stringify(this.options)),this.options.customNetworkCheck||(window.addEventListener("online",R.bind(this)),window.addEventListener("offline",U.bind(this)))}function R(){e.debug("Network Up",Date.now(),"ReadyState: ",n&&n.readyState);var t=this;n&&1===n.readyState?(e.debug("Websocket is available"),t.sendMessage(Utils.stringify(x(++l))),k.call(t,l),S.call(t)):n&&0==n.readyState?e.log("Websocket is already in connecting state."):h.call(t,t.apiKey,t.mode),this.options.customNetworkCheck||t.emit("networkconnected")}function U(){e.debug("Network Down",Date.now());b.call(this),this.options.customNetworkCheck||this.emit("networkdisconnected")}var D=function(e,t){EventEmitter.call(this),this.reconnectInterval=t.reconnectInterval,this.reconnectFactor=t.reconnectFactor,this.maxReconnects=t.maxReconnects,this.maxReconnectInterval=t.maxReconnectInterval,this.apiKey=e,this.options=t,this.mode=t.mode,h.call(this,this.apiKey,this.mode),M.call(this),E.call(this)};return Utils.inherits(D,EventEmitter),D.prototype.getState=function(){return t},D.prototype.reconnect=function(){"connected"!==t&&"connecting"!==t?Utils.isConnectedToNetwork()?h.call(this,this.apiKey,this.mode):e.debug("Cant connect, Network Down"):e.debug("Already Connected")},D.prototype.sendMessage=function(t){n&&1===n.readyState?n.send(t):e.log("Cant Send Message Invalid Socket Ready State :",n&&n.readyState)},D.prototype.disconnect=function(){I.call(this)},D.prototype.forceReconnect=function(){var e=this;I.call(e),e.once("disconnected",(function(){e.reconnect()}))},window.addEventListener("beforeunload",(function(){Utils.isValidString(o)&&Utils.save(d,o,1)})),D},RTMFactory=function(){var e,t={},n={mode:"live",reconnect:!0,reconnectInterval:1,maxReconnectInterval:10,reconnectFactor:2,maxReconnects:50,oldSocketId:!1,customNetworkCheck:!1};Utils.factory.incrementCount();var o=function o(r,c){if(e instanceof o)return e;if(Utils.factory.getCount()>6)throw new RTMServerException("Number of connection exceeded!");EventEmitter.call(this),this.apiKey=Utils.checkApiKey(r),this.options=Utils.parseOptions(c,n);let s=Utils.createLogger(this.apiKey);var a=new ConnectionFactory(s);this.connection=new a(this.apiKey,this.options),e=this,this.connection.on("server-subscriptionresponse",(function(n){s.debug("Received Subscription Response : ",n);var o=n.data.successfullySubscribed;if(o&&o.length){var r=!0,c=!1,a=void 0;try{for(var l,u=o[Symbol.iterator]();!(r=(l=u.next()).done);r=!0){var d=l.value;d&&d.endsWith("/*")||(t[d]=new i(d))}}catch(e){c=!0,a=e}finally{try{!r&&u.return&&u.return()}finally{if(c)throw a}}e.emit("subscribed",t)}})),this.connection.on("message",(function(n){let{channel:o,echoChannel:r}=n;if(o){let c=t[r]||t[o];c instanceof i?c.emit(n.type||"message",n.data||{},n.userInfo||{},n.meta||{}):"server/ack"!=o&&s.debug("Received a message for unsubscribed channel",o),e.emit(n.type||"message",n.channel,n.data||{},n.userInfo||{},n.meta||{})}}))};Utils.inherits(o,EventEmitter),o.prototype.sendMessage=function(e,t,n,o){var i=Utils.getSocketMessage(e,t,n,o);this.connection.sendMessage(Utils.stringify(i))},o.prototype.destroy=function(){this.connection.disconnect(),e=void 0};var i=function(e){EventEmitter.call(this),this.channelName=e};return Utils.inherits(i,EventEmitter),i.prototype.sendMessage=function(t,n,o){var i=Utils.getSocketMessage(this.channelName,t,n,o);e.connection.sendMessage(Utils.stringify(i))},o},RTMServer=new RTMFactory,RTMServerException=function(e){this.message=e||""};
//# sourceMappingURL=https://assets.anywhereworks.com/rtm/production/default/1.0.2/rtm-client-sdk.min.js.map
